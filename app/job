# app/scheduler/job.py

import asyncio
import datetime
from bot.helpers import send_message
from core.members import find_member, get_sheet
from core.tasks import get_tasks_for
from core.messages import get_random_message

# ---------------------------------------------------------
#  Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù‡Ù…Ù‡ Ø§Ø¹Ø¶Ø§ Ø§Ø² Ø´ÛŒØª members
# ---------------------------------------------------------
def get_all_members():
    rows = get_sheet("members")
    if not rows or len(rows) < 2:
        return []

    members = []
    for row in rows[1:]:
        if not row:
            continue
        chat_id = row[0]
        team = row[3]
        customname = row[4]
        members.append({
            "chat_id": chat_id,
            "team": team,
            "name": customname
        })

    return members


# ---------------------------------------------------------
#  Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡ÙØªÚ¯ÛŒ â€“ Ø´Ù†Ø¨Ù‡ Û¹ ØµØ¨Ø­
# ---------------------------------------------------------
async def send_weekly_tasks():
    members = get_all_members()

    for m in members:
        team = m["team"]
        chat_id = m["chat_id"]
        name = m["name"]

        tasks = get_tasks_for(team, mode="week")

        if not tasks:
            continue

        # Ù¾ÛŒØ§Ù… Ø±Ù†Ø¯ÙˆÙ… Ø§Ø² Ù†ÙˆØ¹ WEEK
        header = get_random_message("WEEK", TEAM=team)

        text = f"{header}\n\n"

        for t in tasks:
            text += f"ğŸ“Œ *{t['title']}*\n"
            text += f"ğŸ“… {t['date']}\n\n"

        await send_message(chat_id, text)

    print("WEEKLY TASKS SENT")


# ---------------------------------------------------------
#  Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø±ÙˆØ²Ø§Ù†Ù‡ â€“ Ù‡Ø± Ø±ÙˆØ² Û¹ ØµØ¨Ø­
# ---------------------------------------------------------
async def send_daily_tasks():
    members = get_all_members()

    for m in members:
        team = m["team"]
        chat_id = m["chat_id"]
        name = m["name"]

        tasks = get_tasks_for(team, mode="today")

        if not tasks:
            continue

        for t in tasks:
            title = t["title"]
            date_fa = t["date"]
            delay_days = 0

            # Ù¾ÛŒØ§Ù… Ø±Ù†Ø¯ÙˆÙ… Ø§Ø² Ù†ÙˆØ¹ DUE (Ú†ÙˆÙ† Ø§Ù…Ø±ÙˆØ² Ø±ÙˆØ² ØªØ­ÙˆÛŒÙ„ Ø§Ø³Øª)
            rnd = get_random_message(
                "DUE",
                NAME=name,
                TEAM=team,
                TITLE=title,
                DATE_FA=date_fa,
                DAYS=delay_days
            )

            text = (
                f"ğŸ“Œ *ØªØ³Ú© Ø§Ù…Ø±ÙˆØ² ØªÛŒÙ… {team}*\n"
                f"ğŸ“… {date_fa}\n"
                f"âœï¸ *{title}*\n\n"
                f"{rnd}"
            )

            await send_message(chat_id, text)

    print("DAILY TASKS SENT")


# ---------------------------------------------------------
#  ØªØ§Ø¨Ø¹ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ
# ---------------------------------------------------------
async def scheduler_loop():
    while True:
        now = datetime.datetime.now()

        # -------------------------------
        #  Ø´Ù†Ø¨Ù‡ Û¹:Û°Û°
        # -------------------------------
        if now.weekday() == 5 and now.hour == 9 and now.minute == 0:
            await send_weekly_tasks()

        # -------------------------------
        #  Ù‡Ø± Ø±ÙˆØ² Û¹:Û°Û°
        # -------------------------------
        if now.hour == 9 and now.minute == 0:
            await send_daily_tasks()

        await asyncio.sleep(30)
